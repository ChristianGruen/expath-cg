<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Facet Module</title><link rel="stylesheet" type="text/css" href="http://www.w3.org/StyleSheets/TR/base.css" /><style type="text/css">
code           { font-family: monospace; }

div.constraint,
div.issue,
div.note,
div.notice     { margin-left: 2em; }

ol.enumar      { list-style-type: decimal; }
ol.enumla      { list-style-type: lower-alpha; }
ol.enumlr      { list-style-type: lower-roman; }
ol.enumua      { list-style-type: upper-alpha; }
ol.enumur      { list-style-type: upper-roman; }


div.exampleInner pre { margin-left: 1em;
                       margin-top: 0em; margin-bottom: 0em}
div.exampleOuter {border: 4px double gray;
                  margin: 0em; padding: 0em}
div.exampleInner { background-color: #d5dee3;
                   border-top-width: 4px;
                   border-top-style: double;
                   border-top-color: #d3d3d3;
                   border-bottom-width: 4px;
                   border-bottom-style: double;
                   border-bottom-color: #d3d3d3;
                   padding: 4px; margin: 0em }
div.exampleWrapper { margin: 4px }
div.exampleHeader { font-weight: bold;
                    margin: 4px}

      code.function { font-weight: bold; }
      code.type { font-style: italic; }
      /* h1, h2, h3 { color: #84001C; background: white } */
      /* a, :link, :visited, a:active { color: #84005C; background: white } */
      body {
        background-image: url(http://expath.org/images/logo-candidate.png);
      }
   </style></head><body><p><a href="http://expath.org/"><img src="http://expath.org/images/expath-logo.png" alt="EXPath" height="32" width="32" /></a></p><div class="head"><p><a href="http://www.w3.org/"><img src="http://www.w3.org/Icons/w3c_home" alt="W3C" height="48" width="72" /></a></p>
<h1><a name="title" id="title"></a>Facet Module</h1>
<h2><a name="w3c-doctype" id="w3c-doctype"></a>EXPath Proposed Module 25 December 2015</h2><dl><dt>This version:</dt><dd>
     <a href="http://expath.org/spec/facet/20151225">http://expath.org/spec/facet/20151225</a><br />
  </dd><dt>Editors:</dt><dd>Zed Zhou, EMC</dd><dd>Carla Spruit, EMC</dd><dt>Contributors:</dt><dd>Jonathan Robie, EMC</dd><dd>Bruno Marquie, EMC</dd></dl><p class="copyright">Published by the <a href="http://w3.org/community/expath/">EXPath Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor
           License Agreement (CLA)</a>. A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is
        available.</p><p class="copyright">This specification was published by the <a href="http://www.w3.org/community/expath/">EXPath Community Group</a>. It is not a W3C Standard nor is it on the W3C
        Standards Track. Please note that under the <a href="http://www.w3.org/community/about/agreements/cla/">W3C Community Contributor
           License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.s
        Learn more about <a href="http://www.w3.org/community/">W3C Community and Business
           Groups</a>.</p></div><hr /><div>
<h2><a name="abstract" id="abstract"></a>Abstract</h2><p>This proposal defines extension functions and data models to enable Faceted navigation/search
        support in XQuery.</p></div><div class="toc">
<h2><a name="contents" id="contents"></a>Table of Contents</h2><p class="toc">1 <a href="#status-of-this-document">Status of this document</a><br />
2 <a href="#introduction">Introduction</a><br />
    2.1 <a href="#namespace-conventions">Namespace conventions</a><br />
    2.2 <a href="#facet-terminologies">Facet terminologies</a><br />
    2.3 <a href="#the-xquery-extension">The XQuery Extension</a><br />
3 <a href="#schema">Schema</a><br />
    3.1 <a href="#element-facet">element facet</a><br />
        3.1.1 <a href="#element-key">element key</a><br />
    3.2 <a href="#element-facets">element facets</a><br />
    3.3 <a href="#element-facet-definition">element facet-definition</a><br />
        3.3.1 <a href="#element-order-by">element order-by</a><br />
        3.3.2 <a href="#element-group-by">element group-by</a><br />
4 <a href="#the-function-definitions">The function definitions</a><br />
    4.1 <a href="#facet-count">facet:count</a><br />
    4.2 <a href="#facet-drill">facet:drill</a><br />
    4.3 <a href="#group-by-function">group-by function</a><br />
5 <a href="#use-cases">Use cases</a><br />
    5.1 <a href="#case-1-simple-facet-based-on-existing-attribute">Case 1: Simple facet based on existing attribute</a><br />
    5.2 <a href="#case-2-simple-customized-facet-based-on-group-by-function">Case 2: Simple customized facet based on group-by function</a><br />
    5.3 <a href="#case-3-counting-facets-when-the-grouping-key-consists-of-more-than-1-value">Case 3: Counting facets when the grouping key consists of more than 1 value</a><br />
    5.4 <a href="#case-4-counting-facets-with-group-by-function-strict-type-checking-and-order-by-value-with-a-collation">Case 4: Counting facets with group-by function strict type checking, and order by value with a collation</a><br />
    5.5 <a href="#case-5-hierarchical-facet">Case 5: Hierarchical facet</a><br />
    5.6 <a href="#case-6-hierarchical-facet-and-drill-sideway">Case 6: Hierarchical facet and drill sideway</a><br />
</p>
<h3><a name="appendices" id="appendices"></a>Appendices</h3><p class="toc">A <a href="#issues-list">Issues list</a><br />
    A.1 <a href="#issue-1-use-annotations-to-associate-a-grouping-function-to-a-facet-definition">Issue 1. Use annotations to associate a grouping function to a facet-definition</a><br />
    A.2 <a href="#issue-2-facet-drill-optimization-and-customizations">Issue 2. Facet drill optimization and customizations</a><br />
B <a href="#sample-data-for-the-use-cases">Sample data for the use cases</a><br />
</p></div><hr /><div class="body"><div class="div1">
<h2><a name="status-of-this-document" id="status-of-this-document"></a>1 Status of this document</h2><p>This document is in an initial submission stage.  Comments are welcomed at <a href="mailto:public-expath@w3.org">public-expath@w3.org</a> 
mailing list (<a href="http://lists.w3.org/Archives/Public/public-expath/">archive</a>).</p></div><div class="div1">
<h2><a name="introduction" id="introduction"></a>2 Introduction</h2><p>Faceted search has proven to be enormously popular in the real world applications.  Faceted search allows user to navigate
 and access information via a structured facet classification system.  Combined with full text search, it provides user
 with enormous power and flexibility to discover information.</p><p>This proposal defines a standardized approach to support the Faceted search in XQuery.  It has been designed to be
compatible with XPath 3.0, and is intended to be used in conjunction with XQuery and XPath Full Text 3.0.</p><div class="div2">
<h3><a name="namespace-conventions" id="namespace-conventions"></a>2.1 Namespace conventions</h3><p>The module defined by this document defines functions and elements in the
namespace <code><a href="http://expath.org/ns/facet">http://expath.org/ns/facet</a></code>. In this document, the
<code>facet</code> prefix is bound to this namespace URI.</p></div><div class="div2">
<h3><a name="facet-terminologies" id="facet-terminologies"></a>2.2 Facet terminologies</h3><ul><li><p>Facet:  refers to an object attribute (in a generic sense, not to be confused with xml attribute) that will be 
aggregated.  For example,  "color" is a facet of "car" object.</p></li><li><p>Facet-value: refers to a value of the facet.  For example, "blue" is a facet-value of the facet "color" for "car" object.</p></li><li><p>The facet aggregation: counting the occurrence of each facet-value in the results.</p></li><li><p>The facet drills:</p><ol class="enumar"><li><p>drill-down: filter the search results by matching a selected facet value. Once a facet-value is drilled down,
the facet is no longer available for selection by the user, thus only one facet-value in the same facet can be
drilled-down at a time.  Example:</p><div class="exampleInner"><pre>
- Color                                  - Color
  - blue(10)    -&gt; User select blue  -&gt;    x blue(10)
  - red(6)
  - yellow(2)

* In UI, Color:blue is now shown as selected, the other values of facet "Color" are no longer
available for further selection
</pre></div></li><li><p>drill-sideway:  also known as multi-select facets. Filter the search results by matching against multiple facet
values of the same facet.  Example:</p><div class="exampleInner"><pre>
- Color                         - Color                     - Color
  - blue(10)  -&gt; select blue -&gt;   x blue(10)  -&gt; then red -&gt;  x blue(10)
  - red(6)                        - red(6)                    x red(6)
  - yellow(2)                     - yellow(2)                 - yellow(2)
</pre></div></li></ol></li><li><p>Hierarchical facets.  Organizing multiple facets in a hierarchical structure.  When
a facet is a part of hierarchy, it must be aggregated in relation to its parent facet.  This concept
is also sometimes referred to as pivot facet.</p><p>For example:</p><div class="exampleInner"><pre>
 Flat facets                Hierarchical facets, "Color" is child of "Make"
 - Make                     - Make
   - Audi(10)                 - Audi(10)
                    ----&gt;        - Color
 - Color                          - Blue(5)
   - Blue(10)

 * There are 10 blue cars in total, but only 5 blue Audi.
</pre></div></li></ul></div><div class="div2">
<h3><a name="the-xquery-extension" id="the-xquery-extension"></a>2.3 The XQuery Extension</h3><p>The faceted search support consists of the definitions of the facet data models, and the XQuery functions
that manipulate the data models to perform facet aggregation and drills.  The following sections contain
the detailed specification of the data models and the XQuery functions.  The <a href="#use-cases">Use Cases</a> section contains
the examples demonstrating the application of this facet proposal with some sample data. </p></div></div><div class="div1">
<h2><a name="schema" id="schema"></a>3 Schema</h2><p>Below is the RelaxNG Compact grammar for the facet data models:</p><div class="exampleInner"><pre>
default namespace facet = "http://expath.org/ns/facet"
datatypes xs = "http://www.w3.org/2001/XMLSchema-datatypes"

start = Facet

Facet = element facet {
  attribute name { xs:string },
  element key {
      attribute value { xs:string },
      attribute count { xs:integer },
      attribute type  { xs:QName }?,
      AnyElement*,
      Facet*
  }*,
  AnyElement*
}

Facets = element facets {
    Facet*,
    AnyElement*
}

FacetDef = element facet-definition {
    attribute name { xs:string },
    element group-by {
        attribute function { xs:QName }?,
        attribute collation { xs:string }?,
        attribute type { xs:string }?,
        element sub-path { text } +,
        AnyElement*
    },
    element max-values { xs:integer }?,
    element order-by {
        attribute direction { "ascending" | "descending" },
        attribute empty { "greatest" | "least" }?,
        "value" | "count"
    }?,

    AnyElement*,
    FacetDef*,
}

# Denotes any element that does not belong to facet namespace
AnyElement = element * - facet:* {
    ( attribute * - facet:* { text }
    | text 
    | AnyElement )*
}
</pre></div><p>Example:</p><div class="exampleInner"><pre>
&lt;facet-definition xmlns="http://expath.org/ns/facet" name="Country"&gt;
    &lt;group-by&gt;
        &lt;sub-path&gt;location/country&lt;/sub-path&gt;
    &lt;/group-by&gt;
    &lt;max-values&gt;100&lt;/max-values&gt;
    &lt;order-by direction="ascending"&gt;value&lt;/order-by&gt;
&lt;/facet-definition&gt;

&lt;facets xmlns="http://expath.org/ns/facet"&gt;
    &lt;facet name="country"&gt;
        &lt;key count="2" value="US"/&gt;
    &lt;/facet&gt;
&lt;/facets&gt;
</pre></div><div class="div2">
<h3><a name="element-facet" id="element-facet"></a>3.1 element facet</h3><ul><li><p>attribute name : The facet name</p></li><li><p>element key  : Contains all information pertaining to a facet grouping key. See the <a href="#element-key">element key</a>.</p></li><li><p>AnyElement*  : For customization.</p></li></ul><div class="div3">
<h4><a name="element-key" id="element-key"></a>3.1.1 element key</h4><ul><li><p>attribute value : The facet value</p></li><li><p>attribute count : Number of occurrences counted for this facet value in the results</p></li><li><p>attribute type  : Facet value data type,  always one of xs:anyAtomicType.  Optional attribute: when not specified, the default value is "xs:string".</p></li><li><p>AnyElement*     : Any elements that do not belong to the facet namespace, for customization.</p></li><li><p>element facet* :  Optional nested facets, for supporting hierarchical facets.</p></li></ul></div></div><div class="div2">
<h3><a name="element-facets" id="element-facets"></a>3.2 element facets</h3><ul><li><p>element facet* : Zero or more facet elements.</p></li><li><p>AnyElement*    : For customization.</p></li></ul></div><div class="div2">
<h3><a name="element-facet-definition" id="element-facet-definition"></a>3.3 element facet-definition</h3><ul><li><p>attribute name : Defines the facet name.</p></li><li><p>element group-by : Parameters for obtaining facet values from a sequence of items.  Facet value is similar to the
concept of grouping key defined in the <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a>.
The key difference is that there is one and only one grouping key per result item, but there could be zero 
or more facet value(s) per result item.  See this <a href="#element-group-by">section</a> for more details.</p></li><li><p>element max-values : Optional limit for maximum number of facet values to be returned, after ordering is applied.</p></li><li><p>element order-by   : Optional ordering parameters to specify the order of returned facet values.  See this <a href="#element-order-by">section</a>.</p></li><li><p>AnyElement*    : For customization.</p></li><li><p>element facet-definition* : Optional nested facet definitions for supporting hierarchical facets.</p></li></ul><div class="div3">
<h4><a name="element-order-by" id="element-order-by"></a>3.3.1 element order-by</h4><ul><li><p>attribute direction : One of "ascending" or "descending".  See <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#prod-xquery31-OrderModifier">OrderModifier</a></p></li><li><p>attribute empty     : One of "greatest" or "least".  See <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#prod-xquery31-OrderModifier">OrderModifier</a></p></li><li><p>content is one of<ul><li><p>"value" : Order by /facet/key/@value</p></li><li><p>"count" : Order by /facet/key/@count, as xs:integer</p></li></ul>
</p></li><li><p>When ordering by "value", where the facet values are of xs:string type, and attribute collation is specified in
the group-by element, implementation must order the string values using the specified collation.</p></li><li><p>If order-by is not specified, then implementation must by default order by "count", with direction "descending".</p></li></ul></div><div class="div3">
<h4><a name="element-group-by" id="element-group-by"></a>3.3.2 element group-by</h4><ul><li><p>attribute function : An optional string containing the QName of a function that returns customized facet values</p></li><li><p>attribute collation : An optional string defined as <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#doc-xquery31-URILiteral">URILiteral</a>.
Collation is used to determine the equality of facet values of xs:string type.  See
<a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a> for the
detailed semantics of this attribute.  If not specified, the default collation is used.</p></li><li><p>attribute type : An optional string containing a xs:QName plus an optional <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#prod-xquery31-OccurrenceIndicator">OccurrenceIndicator</a>.
xs:QName must refer to a xs:anyAtomicType.
When specified, strict type and cardinality checks are enforced on the facet values before
they are counted.  See <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a>
for the detailed semantics of this attribute.</p></li><li><p>element sub-path<ul><li><p>As defined by <a href="http://www.w3.org/TR/xmlschema11-1/#c-selector-xpath">selector-XPath</a>, the sub-path is relative to
each item in the results sequence passed to the function "facet:count".</p></li><li><p>If attribute function is provided, then more than 1 sub-path may be specified , otherwise only 1 sub-path is
allowed</p></li></ul>
</p></li><li><p>AnyElement*  : For customization.</p></li></ul><p>The facet value grouping rules to obtain and count the facet values are mostly identical to the rules specified by <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a>.
More specifically:</p><ol class="enumar"><li><p>For every item of the results sequence, the sub-path expressions are evaluated with the item as the context item.</p></li><li><p>The results are then atomized to a sequence of zero or more atomic values.</p></li><li><p>Apply the group-by function if specified.<ul><li><p>If no group-by function exists, the atomized results from step 2 are the facet values.</p></li><li><p>If group-by function exists, the results from step 2 are passed to the group-by function.  The returned result
from the group-by function are the facet values.</p></li></ul>
</p></li><li><p>If attribute type is specified, strong type and cardinality checks are performed on the facet values.  Error
<a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#ERRXPTY0004">err:XPTY0004</a> should be raised if check fails.</p></li><li><p>Facet values are then counted using the same equality rule as defined by <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a>,
using the collation attribute when specified.</p></li></ol><p>There exists a key difference between the grouping-key defined in <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#id-group-by">group-by-clause</a>
and the facet value.  The following rule for "grouping-key" does not apply to facet-value:</p><div class="exampleInner"><pre>
If the value of any grouping variable consists of more than one item, a type error is raised [err:XPTY0004].
</pre></div><p>For facet, it's perfectly logical to have a result item to be counted towards multiple facet values or none at all, 
thus there may exist zero or more facet values per result item.</p><p>For conciseness, the following examples show the equivalent group-by clauses for some group-by elements, assuming
there is exactly one facet value (grouping key) per result item.</p><p>Example 1:</p><div class="exampleInner"><pre>
group by $d := $item//sub-path
order by count($item) descending

&lt;group-by&gt;
    &lt;sub-path&gt;//sub-path&lt;/sub-path&gt;
&lt;/group-by&gt;
</pre></div><p>Example 2:</p><div class="exampleInner"><pre>
group by $d := local:group-function($item//sub-path)
order by count($item) descending

&lt;group-by function="local:group-function"&gt;
    &lt;sub-path&gt;//sub-path&lt;/sub-path&gt;
&lt;/group-by&gt;
</pre></div><p>Example 3:</p><div class="exampleInner"><pre>
group by $d := local:group-function($item//sub-path) collation "Spanish"
order by count($item) descending

&lt;group-by function="local:group-function" collation="Spanish"&gt;
    &lt;sub-path&gt;//sub-path&lt;/sub-path&gt;
&lt;/group-by&gt;
</pre></div><p>Example 4:</p><div class="exampleInner"><pre>
group by $d as xs:string := local:group-function($item//sub-path) collation "Spanish"
order by count($item) descending

&lt;group-by function="local:group-function" collation="Spanish" type="xs:string"&gt;
    &lt;sub-path&gt;//sub-path&lt;/sub-path&gt;
&lt;/group-by&gt;
</pre></div></div></div></div><div class="div1">
<h2><a name="the-function-definitions" id="the-function-definitions"></a>4 The function definitions</h2><div class="div2">
<h3><a name="facet-count" id="facet-count"></a>4.1 facet:count</h3><p><strong>Signature</strong></p><div class="exampleInner"><pre>
<strong>facet:count</strong>($results as <em>item()*</em>,
    $facet-definitions as <em>element(facet:facet-definition)*</em>) as <em>element(facet:facets)</em>
</pre></div><p><strong>Properties</strong></p><p>This function is: deterministic, context-independent, focus-independent</p><p><strong>Rules</strong></p><p>Given a result sequence, and a sequence of facet definitions, count the facet-values for each facet defined
by the facet definition(s).</p></div><div class="div2">
<h3><a name="facet-drill" id="facet-drill"></a>4.2 facet:drill</h3><p><strong>Signature</strong></p><div class="exampleInner"><pre>
<strong>facet:drill</strong>($results as <em>item()*</em>,
    $facet-definition as <em>element(facet:facet-definition)</em>,
    $selected-facet as <em>element(facet:facet)</em>) as <em>item()*</em>
</pre></div><p><strong>Properties</strong></p><p>This function is: deterministic, context-independent, focus-independent</p><p><strong>Rules</strong></p><p>Given a result sequence, a facet definition, and a selected facet value contained in the facet element, return the
results that match the selected facet value.  This function can be used by both drill-down and drill-sideway queries.</p><p>In the case of hierarchical facets, the $selected-facet must have compatible hierarchical structure as $facet-definition.
This should be true by default if an application constructed $selected_facet from the facets element returned by facet:count
function using the same $facet-definition).  See use cases for more details.</p></div><div class="div2">
<h3><a name="group-by-function" id="group-by-function"></a>4.3 group-by function</h3><p><strong>Signature</strong></p><div class="exampleInner"><pre>
<strong>facet:group-by-function</strong>($facet-definition as <em>element(facet:facet-definition)</em>,
    $sub-path-values as <em>xs:anyAtomicType*</em>,
    ...) as <em>xs:anyAtomicType*</em>;
</pre></div><p><strong>Properties</strong></p><p>This function is: deterministic, context-independent, focus-independent</p><p><strong>Rules</strong></p><p>The group-by function is supplied by the application, called by both facet:count and facet:drill.</p><p>The group-by function is a function that generates facet values from the original values.  Each item in the returned
sequence is a facet value that must be counted by facet:count, or compared against by facet:drill.  An empty
return sequence is also allowed.</p><p>As facet-definition's group-by element may define multiple sub-path child elements, the group-by function has arity
ranging from 2 to infinity.  The atomized sub-path values are passed to the group-by function in the same order as
defined in the group-by element.</p><p>Element facet-definition is also passed to the group-by function to allow an application to pass customized parameters
to the group-by function.</p><p>In the case of hierarchical facet definition, facet:count and facet:drill must pass in the matching
facet-definition element in the hierarchical structure to the group-by function.  For example:</p><div class="exampleInner"><pre>
&lt;facet-definition xmlns="http://expath.org/ns/facet" name="Country"&gt;
    &lt;group-by&gt;
      &lt;sub-path&gt;//country&lt;/sub-path&gt;
    &lt;/group-by&gt;
    &lt;facet-definition name="region"&gt;    &lt;!--  this is the facet-definition passed to local:group-by-region, instead
                                              of the 'Country' facet-definition above--&gt;
      &lt;group-by function="local:group-by-region"&gt;
        &lt;sub-path&gt;//gps-coordinates&lt;/sub-path&gt;
      &lt;/group-by&gt;
    &lt;/facet-definition&gt;
&lt;/facet-definition&gt;
</pre></div></div></div><div class="div1">
<h2><a name="use-cases" id="use-cases"></a>5 Use cases</h2><p>For the use cases, we use the sample "employee" data in Appendix B.  Here is what one employee element looks like:</p><div class="exampleInner"><pre>
&lt;employee&gt;
    &lt;name&gt;John Doe&lt;/name&gt;
    &lt;sex&gt;Male&lt;/sex&gt;
    &lt;organization&gt;HR&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;USA&lt;/country&gt;
      &lt;state&gt;CA&lt;/state&gt;
      &lt;city&gt;Pleasanton&lt;/city&gt;
    &lt;/location&gt;
    &lt;age&gt;21&lt;/age&gt;
    &lt;employDate&gt;2010-02-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;word&lt;/skill&gt;
      &lt;skill&gt;excel&lt;/skill&gt;
      &lt;skill&gt;windows&lt;/skill&gt;
    &lt;/skills&gt;
&lt;/employee&gt;
</pre></div><div class="div2">
<h3><a name="case-1-simple-facet-based-on-existing-attribute" id="case-1-simple-facet-based-on-existing-attribute"></a>5.1 Case 1: Simple facet based on existing attribute</h3><p>The XQuery using this facet proposal:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
let $facetDefinition :=
  &lt;facet:facet-definition name="Org"&gt;
    &lt;facet:group-by&gt;
      &lt;facet:sub-path&gt;organization&lt;/facet:sub-path&gt;
    &lt;/facet:group-by&gt;
  &lt;/facet:facet-definition&gt;
return facet:count( $employees, $facetDefinition )
</pre></div><p>The equivalent XQuery using group-by-clause, since employee belongs to one and only one organization:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
return
  &lt;facet:facets&gt;
    &lt;facet:facet name='Org'&gt;
      {
      for $e in $employees
      group by $org := $e/organization
      order by count($e) descending
      return &lt;facet:key value="{ $org }" count="{ count($e) }"/&gt;
      }
    &lt;/facet:facet&gt;
  &lt;/facet:facets&gt;
</pre></div><p>Expected result:</p><div class="exampleInner"><pre>
&lt;facets xmlns="http://expath.org/ns/facet"&gt;
  &lt;facet name="Org"&gt;
    &lt;key value="Sales" count="3"/&gt;
    &lt;key value="HR" count="2"/&gt;
    &lt;key value="Finance" count="1"/&gt;
  &lt;/facet&gt;
&lt;/facets&gt;
</pre></div></div><div class="div2">
<h3><a name="case-2-simple-customized-facet-based-on-group-by-function" id="case-2-simple-customized-facet-based-on-group-by-function"></a>5.2 Case 2: Simple customized facet based on group-by function</h3><p>The XQuery using this facet proposal:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
declare function local:group-by-org($facetDef, $orgs) {
  if ($orgs = ('Sales', 'Finance'))
  then 'Sales and Finance'
  else 'Other departments'
};

let $facetDefinition :=
&lt;facet:facet-definition name="Org"&gt;
  &lt;facet:group-by function="local:group-by-org"&gt;
    &lt;facet:sub-path&gt;organization&lt;/facet:sub-path&gt;
  &lt;/facet:group-by&gt;
&lt;/facet:facet-definition&gt;
return facet:count($employees, $facetDefinition)
</pre></div><p>The equivalent XQuery using group-by-clause:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
declare function local:group-by-org ($facetVals) {
  if ($facetVals = ('Sales', 'Finance'))
  then 'Sales and Finance'
  else 'Other departments'
};
return
  &lt;facet:facets&gt;
    &lt;facet:facet name="Org"&gt;
      {
      for $e in $employees
      group by $org := local:group-by-org($e/organization)
      order by count($e) descending
      return &lt;facet:key value="{ $org }" count="{ count($e) }"/&gt;
      }
    &lt;/facet:facet&gt;
  &lt;/facet:facets&gt;
</pre></div><p>Expected result:</p><div class="exampleInner"><pre>
&lt;facets xmlns="http://expath.org/ns/facet"&gt;
  &lt;facet name="Org"&gt;
    &lt;key value="Sales and Finance" count="4"/&gt;
    &lt;key value="Other departments" count="2"/&gt;
  &lt;/facet&gt;
&lt;/facets&gt;
</pre></div></div><div class="div2">
<h3><a name="case-3-counting-facets-when-the-grouping-key-consists-of-more-than-1-value" id="case-3-counting-facets-when-the-grouping-key-consists-of-more-than-1-value"></a>5.3 Case 3: Counting facets when the grouping key consists of more than 1 value</h3><p>The XQuery using this facet proposal:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
let $facetDefinition :=
  &lt;facet:facet-definition name="Skill"&gt;
    &lt;facet:group-by&gt;
      &lt;facet:sub-path&gt;skills/skill&lt;/facet:sub-path&gt;
    &lt;/facet:group-by&gt;
  &lt;/facet:facet-definition&gt;
return facet:count( $employees, $facetDefinition)
</pre></div><p>There is no equivalent XQuery using group-by-clause, because skill is a repeatable element.
Following XQuery will throw <a href="http://www.w3.org/TR/2014/WD-xquery-31-20140424/#ERRXPTY0004">err:XPTY0004</a>.</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
&lt;facet:facets&gt;
  &lt;facet:facet name="Skill"&gt;
    {
    for $e in $employees
    let $skill := $e/skills/skill
    group by $skill
    return &lt;facet:key value="{ $skill }" count="{ count($e) }"/&gt;
    }
  &lt;/facet:facet&gt;
&lt;/facet:facets&gt;
</pre></div><p>Expected result:</p><div class="exampleInner"><pre>
 &lt;facets xmlns="http://expath.org/ns/facet"&gt;
  &lt;facet name="Skill"&gt;
    &lt;key value="Word" count="4"/&gt;
    &lt;key value="PowerPoint" count="4"/&gt;
    &lt;key value="Excel" count="2"/&gt;
    &lt;key value="Windows" count="1"/&gt;
    &lt;key value="Linux" count="1"/&gt;
    &lt;key value="OpenOffice" count="1"/&gt;
    &lt;key value="PhotoShop" count="1"/&gt;
    &lt;key value="Negotiation" count="1"/&gt;
  &lt;/facet&gt;
&lt;/facets&gt;
</pre></div></div><div class="div2">
<h3><a name="case-4-counting-facets-with-group-by-function-strict-type-checking-and-order-by-value-with-a-collation" id="case-4-counting-facets-with-group-by-function-strict-type-checking-and-order-by-value-with-a-collation"></a>5.4 Case 4: Counting facets with group-by function strict type checking, and order by value with a collation</h3><p>The XQuery using this facet proposal:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
declare function local:group-by-org($facetVals, $facetDef) {
  if ($facetVals = ('Sales', 'Finance'))
  then 'Sales and Finance'
  else 'Other departments'
};

let $facetDefinition :=
&lt;facet:facet-definition name="Org"&gt;
  &lt;facet:group-by function="local:group-by-org" type='xs:string' collation='fr_FR'&gt;
    &lt;facet:sub-path&gt;organization&lt;/facet:sub-path&gt;
  &lt;/facet:group-by&gt;
  &lt;facet:order-by direction="ascending" empty='least'&gt;value&lt;/facet:order-by&gt;
&lt;/facet:facet-definition&gt;
return facet:count(/employees/employee, $facetDefinition)
</pre></div><p>The equivalent XQuery using group-by-clause:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
declare function local:group-by-org($facetVals) {
  if ($facetVals = ('Sales', 'Finance'))
  then 'Sales and Finance'
  else 'Other departments'
};
&lt;facet:facets&gt;
  &lt;facet:facet name='Org'&gt;
    {
    for $e in /employees/employee
    group by $org as xs:string := local:group-by-org($e/organization) collation 'fr_FR'
    order by $org ascending empty least collation 'fr_FR'
    return &lt;facet:key value="{ $org }" count="{ count($e) }"/&gt;
    }
  &lt;/facet:facet&gt;
&lt;/facet:facets&gt;
</pre></div><p>Expected result:</p><div class="exampleInner"><pre>
&lt;facets xmlns="http://expath.org/ns/facet"&gt;
  &lt;facet name="Org"&gt;
    &lt;key value="Other departments" count="2"/&gt;
    &lt;key value="Sales and Finance" count="4"/&gt;
 &lt;/facet&gt;
&lt;/facets&gt;
</pre></div></div><div class="div2">
<h3><a name="case-5-hierarchical-facet" id="case-5-hierarchical-facet"></a>5.5 Case 5: Hierarchical facet</h3><p>The XQuery using this facet proposal:</p><div class="exampleInner"><pre>
declare namespace facet = "http://expath.org/ns/facet";
let $facetDefinition :=
    &lt;facet-definition xmlns="http://expath.org/ns/facet"&gt;
        &lt;name&gt;State&lt;/name&gt;
        &lt;group-by&gt;
            &lt;sub-path&gt;//state&lt;/sub-path&gt;
        &lt;/group-by&gt;
        &lt;facet-definition&gt;
            &lt;name&gt;Skill&lt;/name&gt;
            &lt;group-by&gt;
                &lt;sub-path&gt;//skill&lt;/sub-path&gt;
            &lt;/group-by&gt;
        &lt;/facet-definition&gt;
    &lt;/facet-definition&gt;
return facet:count( $employees, $facetDefinition)
</pre></div><p>Expected result:</p><div class="exampleInner"><pre>
&lt;facets xmlns="http://expath.org/ns/facet"&gt;
  &lt;facet name="State"&gt;
    &lt;key count="3" value="WA"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="2" value="Word"/&gt;
            &lt;key count="2" value="PowerPoint"/&gt;
            &lt;key count="1" value="OpenOffice"/&gt;
            &lt;key count="1" value="PhotoShop"/&gt;
        &lt;/facet&gt;
    &lt;/value
    &lt;key count="2" value="CA"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="2" value="Word"/&gt;
            &lt;key count="2" value="Excel"/&gt;
            &lt;key count="1" value="PowerPoint"/&gt;
            &lt;key count="1" value="Linux"/&gt;
            &lt;key count="1" value="Windows"/&gt;
        &lt;/facet&gt;
    &lt;/value
    &lt;key count="1" value="OR"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="1" value="PowerPoint"/&gt;
            &lt;key count="1" value="Negotiation"/&gt;
        &lt;/facet&gt;
    &lt;/value&gt;
  &lt;/facet&gt;
&lt;/facets&gt;
</pre></div><p>The application displays:</p><div class="exampleInner"><pre>
State
- WA (3)
  Skill
  x Word (2)     &lt;=  User select this facet value
  - PowerPoint (2)
  - OpenOffice (1)
  - PhotoShop (1)
- CA (2)
  Skill
  - Word (2)
  - Excel (2)
  - PowerPoint (1)
  - Linux (1)
  - Windows (1)
- OR (1)
  Skill
  - PowerPoint (1)
  - Negotiation (1)
</pre></div><p>The application then constructs following facet element, based on user's selection:</p><div class="exampleInner"><pre>
&lt;facet xmlns="http://expath.org/ns/facet" name="State"&gt;
    &lt;key count="2" value="WA"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="2" value="Word"/&gt;
        &lt;/facet&gt;
    &lt;/value
&lt;/facet&gt;
</pre></div><p>The application then calls facet:drill, which is able to map the selected facet element to the facet-definition, 
and effectively applies following XQuery filter expression to the result set:</p><div class="exampleInner"><pre>
$employee//state = "WA" and $employee//skill = "Word"
</pre></div></div><div class="div2">
<h3><a name="case-6-hierarchical-facet-and-drill-sideway" id="case-6-hierarchical-facet-and-drill-sideway"></a>5.6 Case 6: Hierarchical facet and drill sideway</h3><p>Continuing from previous case, if the application allows user to simultaneously select multiple skills:</p><div class="exampleInner"><pre>
State
- WA (3)
  Skill
  - Word (2)
  - PowerPoint (2)
  - OpenOffice (1)
  - PhotoShop (1)
- CA (2)
  Skill
  x Word (2)          &lt;=  User select this facet value
  x Excel (2)         &lt;=  and this facet value
  - PowerPoint (1)
  - Linux (1)
  - Windows (1)
- OR (1)
  Skill
  - PowerPoint (1)
  - Negotiation (1)
</pre></div><p>The application then constructs following two facet elements, based on user's selection:</p><div class="exampleInner"><pre>
let $selected-facet1 :=
&lt;facet xmlns="http://expath.org/ns/facet" name="State"&gt;
    &lt;key count="2" value="CA"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="2" value="Word"/&gt;
        &lt;/facet&gt;
    &lt;/value
&lt;/facet&gt;

let $selected-facet2 :=
&lt;facet xmlns="http://expath.org/ns/facet" name="State"&gt;
    &lt;key count="2" value="CA"&gt;
        &lt;facet name="Skill"&gt;
            &lt;key count="1" value="Excel"/&gt;
        &lt;/facet&gt;
    &lt;/value
&lt;/facet&gt;
</pre></div><p>And constructs the following XQuery:</p><div class="exampleInner"><pre>
for $e in $employees[
    facet:drill(., $facet-definition, $selected-facet1) or
    facet:drill(., $facet-definition, $selected-facet2)
] return $e
</pre></div><p>Which is effectively the same as:</p><div class="exampleInner"><pre>
for $e in $employees[
    (//state = 'CA' and //skill = 'Word') or
    (//state = 'CA' and //skill = 'Excel')
] return $e
</pre></div></div></div></div><div class="back"><div class="div1">
<h2><a name="issues-list" id="issues-list"></a>A Issues list</h2><div class="div2">
<h3><a name="issue-1-use-annotations-to-associate-a-grouping-function-to-a-facet-definition" id="issue-1-use-annotations-to-associate-a-grouping-function-to-a-facet-definition"></a>A.1 Issue 1. Use annotations to associate a grouping function to a facet-definition</h3><p>As an alternative to specifying a function QName in /facet-definition/group-by/@function, annotation
may be used to associate a grouping function to a facet-definition.</p><p>Example:</p><div class="exampleInner"><pre>
&lt;facet-definition xmlns="http://expath.org/ns/facet" name="age"&gt;
    &lt;group-by function="age-range"&gt;
        &lt;sub-path&gt;//age&lt;/sub-path&gt;
    &lt;/group-by&gt;
&lt;/facet-definition&gt;

declare function %facet:group-by("age-range")local:age-range(
  $facet-definition as element(facet:facet-definition)
  $ages as xs:anyAtomicType*,
) as xs:anyAtomicType* {
    (: .... :)
}
</pre></div><p>In the example above, annotation "age-range" is used to associated the facet-definition to the function local:age-range.</p><p>Annotation introduces an additional level of indirection to link a facet-definition to a group-by function.  The 
indirection does not appear to improve or simplify the API.  Thus currently we chose the straight forward function 
QName association via attribute.</p></div><div class="div2">
<h3><a name="issue-2-facet-drill-optimization-and-customizations" id="issue-2-facet-drill-optimization-and-customizations"></a>A.2 Issue 2. Facet drill optimization and customizations</h3><p>When facet:drill encounters a facet-definition that defines a group-by function, it's effectively filtering results
using the following XQuery expression:</p><div class="exampleInner"><pre>
$selected-facet-value = group-by-function($facet-def, $result)
</pre></div><p>One main draw back of the above filtering implementation is that it voids any indexing optimization.  To illustrate
this, lets use a common numeric range facet as an example.</p><p>Suppose we've customized the following age range facet based on the same <em>employee</em> data in the use-cases above:</p><div class="exampleInner"><pre>
&lt;facet-definition xmlns="http://expath.org/ns/facet" name="Age Range"&gt;
    &lt;group-by function="local:group-by-range"&gt;
        &lt;sub-path&gt;//age&lt;/sub-path&gt;
    &lt;/group-by&gt;
&lt;/facet-definition&gt;

declare function local:group-by-range(
  $facet-definition as element(facet:facet-definition)
  $ages as xs:anyAtomicType*,
) as xs:anyAtomicType* {
  for $age in $ages return 
    if (xs:integer($age) &lt;20 ) then "&lt;20";
    else if (xs:integer($age) &lt;30 ) then "20-30";
    else "30+"
}
</pre></div><p>Default facet:filter implementation translates to the following equivalent XQuery expression:</p><div class="exampleInner"><pre>
(: ... other constraints ... :) and $selected-age-range = local:group-by-range($employee//age)
</pre></div><p>Application may choose to perform facet drill by directly constructing following XQuery expression:</p><div class="exampleInner"><pre>
(: ... other constraints ... :) and $employee//age &lt; 20   (: if $selected-age-range is "&lt;20" :)
</pre></div><p>The above XQuery constraint expression can be optimized by the engine to use the index, 
which is clearly faster than using the default facet:drill implementation.</p><p>Another example is the 'dynamic-age-range' facet, where the age range is determined by the minimum and
the maximum age values in the result set.  In this case the result set must be pre-scanned before facet:count in order 
to determine the dynamic range, and the range information must be persisted into <em>facet</em> element to make facet drill query
possible later on.  These types of dynamic facets will require an application to implement customization, in addition
to just using the standard methods/approaches described in this proposal.</p><p>To completely support all possible real world facet requirements may be too complex for this proposal.  For this
reason we've decided to make <em>facet</em> and <em>facet-definition</em> elements extensible by allowing the inclusion of non
facet namespace elements.  The implementation will then be able to choose to offer full support for above mentioned
optimization and customizations via extensions.</p></div></div><div class="div1">
<h2><a name="sample-data-for-the-use-cases" id="sample-data-for-the-use-cases"></a>B Sample data for the use cases</h2><p>The complete sample data used by the use cases, presented as an XQuery.</p><div class="exampleInner"><pre>
let $sample :=
&lt;sample&gt;
  &lt;employee&gt;
    &lt;name&gt;John Doe&lt;/name&gt;
    &lt;sex&gt;Male&lt;/sex&gt;
    &lt;organization&gt;HR&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;CA&lt;/state&gt;
      &lt;city&gt;Pleasanton&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-95.677068&lt;/longitude&gt;
        &lt;latitude&gt;37.0625&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;21&lt;/age&gt;
    &lt;employDate&gt;2010-02-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;Word&lt;/skill&gt;
      &lt;skill&gt;Excel&lt;/skill&gt;
      &lt;skill&gt;Windows&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

  &lt;employee&gt;
    &lt;name&gt;Jane Joe&lt;/name&gt;
    &lt;sex&gt;Female&lt;/sex&gt;
    &lt;organization&gt;Finance&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;CA&lt;/state&gt;
      &lt;city&gt;San Francisco&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-122.419416&lt;/longitude&gt;
        &lt;latitude&gt;37.77493&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;18&lt;/age&gt;
    &lt;employDate&gt;2003-02-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;Word&lt;/skill&gt;
      &lt;skill&gt;Excel&lt;/skill&gt;
      &lt;skill&gt;PowerPoint&lt;/skill&gt;
      &lt;skill&gt;Linux&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

  &lt;employee&gt;
    &lt;name&gt;Steve&lt;/name&gt;
    &lt;sex&gt;Male&lt;/sex&gt;
    &lt;organization&gt;HR&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;WA&lt;/state&gt;
      &lt;city&gt;Seattle&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-122.332071&lt;/longitude&gt;
        &lt;latitude&gt;47.60621&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;31&lt;/age&gt;
    &lt;employDate&gt;2010-04-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;OpenOffice&lt;/skill&gt;
      &lt;skill&gt;Word&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

  &lt;employee&gt;
    &lt;name&gt;Kylie&lt;/name&gt;
    &lt;sex&gt;Female&lt;/sex&gt;
    &lt;organization&gt;Sales&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;WA&lt;/state&gt;
      &lt;city&gt;Bellingham&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-122.488225&lt;/longitude&gt;
        &lt;latitude&gt;48.759553&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;23&lt;/age&gt;
    &lt;employDate&gt;2010-06-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;Word&lt;/skill&gt;
      &lt;skill&gt;PowerPoint&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

  &lt;employee&gt;
    &lt;name&gt;Kyle&lt;/name&gt;
    &lt;sex&gt;Male&lt;/sex&gt;
    &lt;organization&gt;Sales&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;WA&lt;/state&gt;
      &lt;city&gt;Bellingham&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-122.499225&lt;/longitude&gt;
        &lt;latitude&gt;48.759553&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;45&lt;/age&gt;
    &lt;employDate&gt;2009-06-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;PowerPoint&lt;/skill&gt;
      &lt;skill&gt;PhotoShop&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

  &lt;employee&gt;
    &lt;name&gt;Mike&lt;/name&gt;
    &lt;sex&gt;Male&lt;/sex&gt;
    &lt;organization&gt;Sales&lt;/organization&gt;
    &lt;location&gt;
      &lt;country&gt;US&lt;/country&gt;
      &lt;state&gt;OR&lt;/state&gt;
      &lt;city&gt;Eugene&lt;/city&gt;
      &lt;gps&gt;
        &lt;longitude&gt;-123.086754&lt;/longitude&gt;
        &lt;latitude&gt;44.052069&lt;/latitude&gt;
      &lt;/gps&gt;
    &lt;/location&gt;
    &lt;age&gt;55&lt;/age&gt;
    &lt;employDate&gt;1999-06-01&lt;/employDate&gt;
    &lt;skills&gt;
      &lt;skill&gt;PowerPoint&lt;/skill&gt;
      &lt;skill&gt;Negotiation&lt;/skill&gt;
    &lt;/skills&gt;
  &lt;/employee&gt;

&lt;/sample&gt;

let $employees := $sample/employee
</pre></div></div></div><script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
         </script><script type="text/javascript">
            try {
               var pageTracker = _gat._getTracker("UA-5463082-2");
               pageTracker._trackPageview();
            } catch(err) {}
         </script></body></html>